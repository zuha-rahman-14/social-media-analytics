{% extends 'base.html' %}
{% block title %}Analyze Post — SocialGuard{% endblock %}
{% block content %}
<div class="page-container">
  <div class="page-header mb-4">
    <h2 class="page-title">Analyze Post</h2>
    <p class="page-subtitle">Upload a post to check engagement and detect modified content</p>
  </div>
  <div class="row g-4">
    <div class="col-lg-8">
      <div class="section-card">
        <form method="POST" enctype="multipart/form-data" id="analyzeForm">
          <div class="mb-4">
            <label class="form-label-custom">Post Image (optional)</label>
            <div class="upload-zone" id="uploadZone" onclick="document.getElementById('imageInput').click()">
              <div class="upload-icon"><i class="bi bi-cloud-arrow-up"></i></div>
              <div class="upload-text">Click to upload or drag & drop</div>
              <div class="upload-sub">PNG, JPG, JPEG up to 16MB</div>
              <input type="file" id="imageInput" name="image" accept="image/*" class="d-none" onchange="previewImage(this)">
            </div>
            <div id="imagePreview" class="mt-3 d-none">
              <img id="previewImg" class="img-preview rounded-3" src="" alt="Preview">
              <button type="button" class="btn btn-sm btn-outline-danger mt-2 rounded-pill" onclick="clearImage()">
                <i class="bi bi-trash me-1"></i>Remove</button>
            </div>
          </div>
          <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <label class="form-label-custom">Post Caption</label>
              <button type="button" class="btn btn-xs btn-outline-secondary rounded-pill" onclick="quickCheck()">
                <i class="bi bi-lightning me-1"></i>Quick Text Check</button>
            </div>
            <textarea name="caption" id="captionInput" class="form-control-custom-lg" rows="4"
                      placeholder="Paste the post caption here…"></textarea>
            <div id="quickCheckResult" class="mt-2 d-none"></div>
          </div>
          <div class="mb-4">
            <label class="form-label-custom mb-3">Engagement Metrics</label>
            <div class="row g-3">
              <div class="col-4">
                <div class="metric-input-card">
                  <div class="metric-icon text-danger"><i class="bi bi-heart-fill"></i></div>
                  <input type="number" name="likes" class="metric-input" value="0" min="0">
                  <div class="metric-label">Likes</div>
                </div>
              </div>
              <div class="col-4">
                <div class="metric-input-card">
                  <div class="metric-icon text-primary-custom"><i class="bi bi-chat-fill"></i></div>
                  <input type="number" name="comments_count" class="metric-input" value="0" min="0">
                  <div class="metric-label">Comments</div>
                </div>
              </div>
              <div class="col-4">
                <div class="metric-input-card">
                  <div class="metric-icon text-success"><i class="bi bi-share-fill"></i></div>
                  <input type="number" name="shares" class="metric-input" value="0" min="0">
                  <div class="metric-label">Shares</div>
                </div>
              </div>
            </div>
          </div>
          <div class="mb-4">
            <label class="form-label-custom">Platform</label>
            <div class="platform-selector">
              {% for plat in ['Instagram', 'Twitter/X', 'Facebook', 'TikTok', 'LinkedIn'] %}
              <label class="platform-option">
                <input type="radio" name="platform" value="{{ plat }}" {% if plat == 'Instagram' %}checked{% endif %}>
                <span class="platform-label">{{ plat }}</span>
              </label>
              {% endfor %}
            </div>
          </div>
          <button type="submit" class="btn btn-primary-custom w-100" id="submitBtn">
            <span class="btn-text"><i class="bi bi-cpu me-2"></i>Run Analysis</span>
            <span class="btn-loading d-none"><span class="spinner-border spinner-border-sm me-2"></span>Analyzing…</span>
          </button>
        </form>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="section-card mb-3">
        <h6 class="sidebar-section-title"><i class="bi bi-image me-2"></i>Image Detection</h6>
        <ul class="info-list">
          <li><i class="bi bi-check2 text-success me-2"></i>Error Level Analysis (ELA)</li>
          <li><i class="bi bi-check2 text-success me-2"></i>Noise pattern comparison</li>
          <li><i class="bi bi-check2 text-success me-2"></i>EXIF metadata inspection</li>
          <li><i class="bi bi-check2 text-success me-2"></i>CNN tamper classification</li>
        </ul>
        <div class="threshold-info">
          <div class="threshold-item"><span class="dot dot-success"></span>&lt;35% Authentic</div>
          <div class="threshold-item"><span class="dot dot-warning"></span>35–65% Suspicious</div>
          <div class="threshold-item"><span class="dot dot-danger"></span>&gt;65% Likely Tampered</div>
        </div>
      </div>
      <div class="section-card">
        <h6 class="sidebar-section-title"><i class="bi bi-type me-2"></i>Text Detection</h6>
        <ul class="info-list">
          <li><i class="bi bi-check2 text-success me-2"></i>Clickbait pattern detection</li>
          <li><i class="bi bi-check2 text-success me-2"></i>Spam &amp; promo language</li>
          <li><i class="bi bi-check2 text-success me-2"></i>Lexical diversity (TTR)</li>
          <li><i class="bi bi-check2 text-success me-2"></i>BERT semantic analysis</li>
        </ul>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
function previewImage(input) {
  if (input.files && input.files[0]) {
    const reader = new FileReader();
    reader.onload = e => {
      document.getElementById('previewImg').src = e.target.result;
      document.getElementById('imagePreview').classList.remove('d-none');
    };
    reader.readAsDataURL(input.files[0]);
  }
}
function clearImage() {
  document.getElementById('imageInput').value = '';
  document.getElementById('imagePreview').classList.add('d-none');
}
async function quickCheck() {
  const text = document.getElementById('captionInput').value.trim();
  if (!text) return;
  const res = document.getElementById('quickCheckResult');
  res.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Checking…';
  res.classList.remove('d-none');
  try {
    const r = await fetch('/api/quick-text-check', {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ text })
    });
    const d = await r.json();
    const color = d.score > 0.65 ? 'danger' : d.score > 0.35 ? 'warning' : 'success';
    res.innerHTML = `<div class="quick-check-result qc-${color}">
      <strong>${d.label}</strong> — Score: <strong>${(d.score*100).toFixed(0)}%</strong>
      ${d.details.length ? '<br><small class="opacity-75">' + d.details.slice(0,3).map(x=>x.rule).join(' · ') + '</small>' : ''}
    </div>`;
  } catch(e) { res.innerHTML = '<span class="text-danger">Check failed.</span>'; }
}
document.getElementById('analyzeForm').onsubmit = () => {
  const btn = document.getElementById('submitBtn');
  btn.querySelector('.btn-text').classList.add('d-none');
  btn.querySelector('.btn-loading').classList.remove('d-none');
  btn.disabled = true;
};
</script>
{% endblock %}
